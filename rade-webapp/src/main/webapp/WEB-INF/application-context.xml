<?xml version="1.0" encoding="UTF-8"?>
<!--/*
 *  This file is part of the Rade project (https://github.com/mgimpel/rade).
 *  Copyright (C) 2018 Marc Gimpel
 *
 *  This program is free software: you can redistribute it and/or modify
 *  it under the terms of the GNU General Public License as published by
 *  the Free Software Foundation, either version 3 of the License, or
 *  (at your option) any later version.
 *
 *  This program is distributed in the hope that it will be useful,
 *  but WITHOUT ANY WARRANTY; without even the implied warranty of
 *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 *  GNU General Public License for more details.
 *
 *  You should have received a copy of the GNU General Public License
 *  along with this program.  If not, see <https://www.gnu.org/licenses/>.
 */-->
<!-- $Id$ --><beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:jdbc="http://www.springframework.org/schema/jdbc"
       xmlns:tx="http://www.springframework.org/schema/tx"
       xmlns:jpa="http://www.springframework.org/schema/data/jpa"
       xmlns:sec="http://www.springframework.org/schema/security"
       xmlns:jaxws="http://cxf.apache.org/jaxws"
       xmlns:jaxrs="http://cxf.apache.org/jaxrs"
       xsi:schemaLocation="
         http://www.springframework.org/schema/beans
         http://www.springframework.org/schema/beans/spring-beans-3.0.xsd
         http://www.springframework.org/schema/jdbc
         http://www.springframework.org/schema/jdbc/spring-jdbc-3.0.xsd
         http://www.springframework.org/schema/tx
         http://www.springframework.org/schema/tx/spring-tx-3.0.xsd
         http://www.springframework.org/schema/data/jpa 
         http://www.springframework.org/schema/data/jpa/spring-jpa-1.8.xsd
         http://www.springframework.org/schema/security
         http://www.springframework.org/schema/security/spring-security-4.2.xsd
         http://cxf.apache.org/jaxws
         http://cxf.apache.org/schemas/jaxws.xsd
         http://cxf.apache.org/jaxrs
         http://cxf.apache.org/schemas/jaxrs.xsd">
  <!-- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -->
  <!-- Persistence Layer (Database & Hibernate) -->
  <!-- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -->

  <!-- Configure the data source bean -->
  <jdbc:embedded-database id="dataSource" type="DERBY">
    <jdbc:script location="classpath:db/sql/create-tables.sql" />
    <jdbc:script location="classpath:db/sql/insert-TypeEntiteAdmin.sql" />
    <jdbc:script location="classpath:db/sql/insert-TypeNomClair.sql" />
    <jdbc:script location="classpath:db/sql/insert-Audit.sql" />
    <jdbc:script location="classpath:db/sql/insert-CirconscriptionBassin.sql" />
    <jdbc:script location="classpath:db/sql/insert-Region.sql" />
    <jdbc:script location="classpath:db/sql/insert-Departement.sql" />
    <jdbc:script location="classpath:db/sql/insert-Commune.sql" />
    <jdbc:script location="classpath:db/sql/insert-Delegation.sql" />
  </jdbc:embedded-database>
<!--
  <bean id="dataSource" class="org.apache.commons.dbcp2.BasicDataSource" destroy-method="close"
        p:driverClassName="org.postgresql.Driver"
        p:url="jdbc:postgresql://RAD-DB-DEV.aesn.fr/RADE_DEV"
        p:username="username"
        p:password="********"/>
-->

  <!-- Create default configuration for Hibernate -->
  <bean id="hibernateJpaVendorAdapter" 
        class="org.springframework.orm.jpa.vendor.HibernateJpaVendorAdapter"/>

  <!-- Configure the entity manager factory bean -->
  <bean id="entityManagerFactory" 
        class="org.springframework.orm.jpa.LocalContainerEntityManagerFactoryBean">
    <property name="dataSource" ref="dataSource"/>
    <property name="jpaVendorAdapter" ref="hibernateJpaVendorAdapter"/>
    <property name="jpaProperties">
      <props>
        <prop key="hibernate.dialect">org.hibernate.dialect.DerbyTenSevenDialect</prop>
        <prop key="hibernate.hbm2ddl.auto">update</prop>
        <prop key="hibernate.show_sql">false</prop>
      </props>
    </property>
    <property name="packagesToScan" value="fr.aesn.rade.persist"/>
  </bean>

  <!-- Configure the transaction manager bean -->
  <bean id="transactionManager" 
    class="org.springframework.orm.jpa.JpaTransactionManager">
    <property name="entityManagerFactory" ref="entityManagerFactory"/>
  </bean>

  <!-- Enable annotation driven transaction management -->
  <tx:annotation-driven/>

  <!-- Configure Spring Data JPA -->
  <jpa:repositories base-package="fr.aesn.rade.persist.dao"/>

  <bean id="entityManager"
        factory-bean="entityManagerFactory"
        factory-method="createEntityManager"/>
  
  <!-- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -->
  <!-- Service Layer -->
  <!-- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -->

  <bean id="metadataService" 
        class="fr.aesn.rade.service.impl.MetadataServiceImpl">
    <constructor-arg ref="entityManager"/>
  </bean>
  <bean id="communeService" 
        class="fr.aesn.rade.service.impl.CommuneServiceImpl">
    <property name="communeJpaDao" ref="communeJpaDao"/>
  </bean>
  <bean id="departementService" 
        class="fr.aesn.rade.service.impl.DepartementServiceImpl">
    <property name="departementJpaDao" ref="departementJpaDao"/>
  </bean>
  <bean id="regionService" 
        class="fr.aesn.rade.service.impl.RegionServiceImpl">
    <property name="regionJpaDao" ref="regionJpaDao"/>
  </bean>
  <bean id="delegationService" 
        class="fr.aesn.rade.service.impl.DelegationServiceImpl">
    <property name="delegationJpaDao" ref="delegationJpaDao"/>
  </bean>

  <!-- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -->
  <!-- CXF Web Services -->
  <!-- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -->

  <import resource="classpath:META-INF/cxf/cxf.xml"/>
  <import resource="classpath:META-INF/cxf/cxf-servlet.xml"/>

<!--
  <bean name="simpleService"
        class="fr.aesn.rade.ws.impl.SimpleServiceImpl">
  </bean>
  <jaxws:endpoint id="SimpleService"
                  implementor="#simpleService"
                  address="/SimpleService"/>
-->
  <bean name="geoAdminService"
        class="fr.aesn.rade.ws.aramis.impl.GeoAdminServiceExternePortImpl">
    <property name="communeService" ref="communeService"/>
    <property name="delegationService" ref="delegationService"/>
    <property name="departementService" ref="departementService"/>
  </bean>
  <jaxws:endpoint id="GeoAdminService"
                  implementor="#geoAdminService"
                  address="/GeoAdminService"/>

<!--
  <bean id="restService"
        class="fr.aesn.rade.rs.RestService">
    <property name="delegationService" ref="delegationService"/>
    <property name="communeService" ref="communeService"/>
    <property name="departementService" ref="departementService"/>
    <property name="regionService" ref="regionService"/>
  </bean>
  <jaxrs:server id="RestService"
                address="/rest">
    <jaxrs:serviceBeans>
      <ref bean="restService"/>
    </jaxrs:serviceBeans>
    <jaxrs:providers>
      <bean class="com.fasterxml.jackson.jaxrs.json.JacksonJsonProvider"/>
    </jaxrs:providers>
  </jaxrs:server>
-->

  <!-- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -->
  <!-- Spring Security -->
  <!-- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -->

<!--
  <sec:debug/>
  <sec:http pattern="/css/**" security="none"/>
  <sec:http pattern="/img/**" security="none"/>
  <sec:http pattern="/services/**" security="none"/>
  <sec:http pattern="/login*" security="none"/>
  <sec:http auto-config="true" use-expressions="true">
    <sec:intercept-url pattern="/**" access="hasRole('ROLE_USER')" />
    <sec:form-login login-page='/login' default-target-url="/welcome.htm"
                    authentication-failure-url="/login"/>
    <sec:csrf/>
  </sec:http>
-->

  <sec:authentication-manager>
    <sec:authentication-provider>
      <sec:user-service>
        <sec:user name="user" password="123456" authorities="ROLE_USER" />
        <sec:user name="admin" password="123456" authorities="ROLE_ADMIN" />
      </sec:user-service>
    </sec:authentication-provider>
  </sec:authentication-manager>

</beans>